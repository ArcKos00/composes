version: "3.9" # Compose specification version

services:
  postgres:
    build: .             # PostgreSQL version
    container_name: pg-main         # Container name
    restart: unless-stopped         # Restart policy

    environment:
      POSTGRES_DB: maindb           # Default database (created on first start)
      POSTGRES_USER: postgres        # Superuser
      POSTGRES_PASSWORD: postgrespostgres
      PGDATA: /var/lib/postgresql/pgdata # Custom data directory inside container
      TZ: Europe/Kyiv               # Timezone

    # PostgreSQL runtime tuning parameters
    command: >
      postgres
      -c max_connections=300
      -c shared_buffers=512MB
      -c effective_cache_size=2GB
      -c maintenance_work_mem=256MB
      -c work_mem=16MB
      -c wal_buffers=16MB
      -c checkpoint_completion_target=0.9
      -c synchronous_commit=on
      -c random_page_cost=1.1
      -c log_min_duration_statement=500
      -c log_connections=on
      -c log_disconnections=on
      -c log_statement=ddl
      -c logging_collector=on
      -c log_directory=/var/log/postgresql
      -c log_filename=postgresql.log
      -c shared_preload_libraries=pg_cron
      -c cron.database_name=maindb

    ports:
      - "5432:5432"  # Expose Postgres to host machine

    volumes:
      - pg_data:/var/lib/postgresql     # Persistent database storage
      - pg_logs:/var/log/postgresql          # Log storage
      - ./init:/docker-entrypoint-initdb.d   # SQL/scripts executed on first init

    # Health check for service readiness
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U appuser -d maindb"]
      interval: 10s
      timeout: 5s
      retries: 5

    # Resource limits (used mainly in swarm mode)
    deploy:
      resources:
        limits:
          cpus: "2.0"    # Max CPU usage
          memory: 4g     # Max memory usage
        reservations:
          memory: 1g     # Reserved memory

    # Increase file descriptor limits
    ulimits:
      nofile:
        soft: 65536
        hard: 65536

#    networks:
#      - pgnet           # Internal docker network

#  pgadmin:
#    image: dpage/pgadmin4:latest
#    container_name: pgadmin
#    restart: unless-stopped

#    environment:
#      PGADMIN_DEFAULT_EMAIL: admin@example.com   # Login email
#      PGADMIN_DEFAULT_PASSWORD: strongpassword  # Login password
#      PGADMIN_CONFIG_SERVER_MODE: "True"        # Multi-user mode
#      PGADMIN_CONFIG_ENHANCED_COOKIE_PROTECTION: "True"
#      TZ: Europe/Kyiv

#    ports:
#      - "54545:80"  # Access pgAdmin via http://localhost:54545

#    volumes:
#      - pgadmin_data:/var/lib/pgadmin  # pgAdmin config storage

      # Optional: auto-register Postgres server
      # - ./pgadmin/servers.json:/pgadmin4/servers.json

#    depends_on:
#      postgres:
#        condition: service_healthy   # Wait until Postgres is ready

#    networks:
#      - pgnet

# Custom internal network
#networks:
#  pgnet:
#    driver: bridge

# Named volumes for persistence
volumes:
  pg_data:
    driver: local
  pg_logs:
    driver: local
#  pgadmin_data:
#    driver: local
